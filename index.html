<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PICA System Professional</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1', // Indigo
                            600: '#4f46e5',
                            700: '#4338ca',
                            900: '#312e81',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
        }
        
        /* Hide app content initially */
        #app-content { display: none; }
        #auth-screen { display: flex; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col selection:bg-brand-100 selection:text-brand-900">

    <!-- AUTH SCREEN (Login / Setup) -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-slate-50 flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-2xl shadow-xl border border-slate-100 p-8 slide-up relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-brand-500 to-purple-600"></div>
            
            <div class="text-center mb-8">
                <div class="bg-brand-50 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 text-brand-600 shadow-sm">
                    <i data-lucide="layers" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-900">PICA System</h2>
                <p class="text-slate-500 text-sm mt-1">Enterprise Problem Solving</p>
            </div>

            <!-- LOGIN FORM (Combined) -->
            <div id="login-form" class="hidden space-y-6">
                <!-- Info Box for Auto Setup -->
                <div id="setup-info" class="hidden bg-blue-50 p-3 rounded-lg border border-blue-100 text-blue-700 text-xs flex gap-2 items-start">
                    <i data-lucide="info" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <strong>Info:</strong> Password Admin default adalah <code>123456</code>.
                    </div>
                </div>

                <!-- Admin Login -->
                <div class="space-y-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase text-center">Login Admin</label>
                    <div class="relative">
                        <input type="password" id="admin-code-input" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all text-center tracking-widest text-lg font-bold" placeholder="Kode Unik">
                        <button id="btn-login-admin" class="absolute right-2 top-2 bottom-2 bg-slate-900 hover:bg-brand-600 text-white px-3 rounded-lg text-sm font-bold transition-colors">
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <p id="login-error" class="text-red-500 text-xs text-center hidden font-medium">Kode salah, silakan coba lagi.</p>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-400 text-xs uppercase font-bold">Atau</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <!-- Guest Button -->
                <button id="btn-guest" class="w-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 font-semibold py-3 rounded-xl transition-all flex items-center justify-center gap-2 group">
                    <i data-lucide="eye" class="w-4 h-4 group-hover:text-brand-600 transition-colors"></i> Masuk sebagai Tamu (View Only)
                </button>
            </div>
            
            <!-- Loading & Error State -->
            <div id="auth-loading" class="text-center py-8">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-brand-500"></i>
                <p id="loading-text" class="text-sm text-slate-400 mt-2">Menghubungkan ke Database...</p>
                <div id="error-help" class="hidden mt-4 text-xs text-red-500 bg-red-50 p-3 rounded text-left">
                    <strong>Koneksi Gagal!</strong><br>
                    1. Cek koneksi internet.<br>
                    2. Pastikan 'Anonymous Auth' aktif di Firebase.<br>
                    3. Pastikan 'Firestore Rules' sudah diatur ke public.<br>
                    <button onclick="location.reload()" class="mt-2 underline text-red-700 font-bold">Coba Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTENT (Hidden until logged in) -->
    <div id="app-content" class="flex flex-col min-h-screen">
        <!-- HEADER -->
        <header class="glass-header sticky top-0 z-40 transition-all duration-300">
            <div class="max-w-[1600px] mx-auto px-4 sm:px-6 h-16 sm:h-20 flex items-center justify-between">
                <div class="flex items-center gap-3 sm:gap-4">
                    <div class="bg-brand-600 p-2 sm:p-2.5 rounded-xl shadow-lg shadow-brand-500/30 text-white transform hover:scale-105 transition-transform duration-300">
                        <i data-lucide="layers" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold tracking-tight text-slate-900 leading-none">PICA<span class="text-brand-600">.sys</span></h1>
                        <p class="text-[10px] sm:text-xs text-slate-500 font-medium mt-0.5 sm:mt-1 tracking-wide uppercase">Enterprise Problem Solving</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 sm:gap-3">
                    <!-- User Role Badge -->
                    <div class="flex items-center gap-2 bg-white border border-slate-200 px-3 sm:px-4 py-1.5 sm:py-2 rounded-full shadow-sm">
                        <div id="user-indicator" class="w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-slate-300"></div>
                        <span id="user-role-label" class="text-[10px] sm:text-xs font-bold text-slate-600 uppercase tracking-wider">Guest</span>
                    </div>
                    
                    <!-- Admin Settings Button -->
                    <button id="btn-settings" class="hidden w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-white border border-slate-200 hover:bg-slate-50 flex items-center justify-center text-slate-600 transition-colors" title="Pengaturan Admin">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                    </button>

                    <!-- Logout Button -->
                    <button id="btn-logout" class="w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-white border border-slate-200 hover:bg-rose-50 hover:border-rose-100 flex items-center justify-center text-slate-600 hover:text-rose-600 transition-colors" title="Keluar">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT BODY -->
        <main class="flex-grow max-w-[1600px] mx-auto px-4 sm:px-6 py-6 sm:py-8 w-full space-y-6 sm:space-y-8">

            <!-- KPI CARDS (Responsive Grid: 2 Cols on Mobile) -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
                <!-- Total Card -->
                <div class="bg-white p-3 sm:p-6 rounded-2xl border border-slate-100 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] hover:-translate-y-1 transition-all duration-300 group relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-slate-200"></div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-start gap-2 sm:gap-0">
                        <div>
                            <p class="text-[10px] sm:text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 sm:mb-2">Total Cases</p>
                            <h3 id="kpi-total" class="text-2xl sm:text-4xl font-bold text-slate-800 tracking-tight">0</h3>
                        </div>
                        <div class="bg-slate-50 p-2 sm:p-3 rounded-xl text-slate-600 group-hover:bg-slate-100 transition-colors self-end sm:self-start">
                            <i data-lucide="database" class="w-4 h-4 sm:w-6 sm:h-6"></i>
                        </div>
                    </div>
                </div>

                <!-- Waiting Card -->
                <div class="bg-white p-3 sm:p-6 rounded-2xl border border-slate-100 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] hover:-translate-y-1 transition-all duration-300 group relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-purple-500"></div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-start gap-2 sm:gap-0">
                        <div>
                            <p class="text-[10px] sm:text-xs font-bold text-purple-500 uppercase tracking-widest mb-1 sm:mb-2 flex items-center gap-1">Waiting <span class="w-1.5 h-1.5 rounded-full bg-purple-500 animate-ping"></span></p>
                            <h3 id="kpi-waiting" class="text-2xl sm:text-4xl font-bold text-slate-800 tracking-tight">0</h3>
                        </div>
                        <div class="bg-purple-50 p-2 sm:p-3 rounded-xl text-purple-600 group-hover:bg-purple-100 transition-colors self-end sm:self-start">
                            <i data-lucide="pause-octagon" class="w-4 h-4 sm:w-6 sm:h-6"></i>
                        </div>
                    </div>
                </div>

                <!-- Progress Card -->
                <div class="bg-white p-3 sm:p-6 rounded-2xl border border-slate-100 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] hover:-translate-y-1 transition-all duration-300 group relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-500"></div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-start gap-2 sm:gap-0">
                        <div>
                            <p class="text-[10px] sm:text-xs font-bold text-brand-500 uppercase tracking-widest mb-1 sm:mb-2">In Progress</p>
                            <h3 id="kpi-progress" class="text-2xl sm:text-4xl font-bold text-slate-800 tracking-tight">0</h3>
                        </div>
                        <div class="bg-brand-50 p-2 sm:p-3 rounded-xl text-brand-600 group-hover:bg-brand-100 transition-colors self-end sm:self-start">
                            <i data-lucide="activity" class="w-4 h-4 sm:w-6 sm:h-6 animate-pulse"></i>
                        </div>
                    </div>
                </div>

                <!-- Closed Card -->
                <div class="bg-white p-3 sm:p-6 rounded-2xl border border-slate-100 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] hover:-translate-y-1 transition-all duration-300 group relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-emerald-500"></div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-start gap-2 sm:gap-0">
                        <div>
                            <p class="text-[10px] sm:text-xs font-bold text-emerald-500 uppercase tracking-widest mb-1 sm:mb-2">Completed</p>
                            <h3 id="kpi-closed" class="text-2xl sm:text-4xl font-bold text-slate-800 tracking-tight">0</h3>
                        </div>
                        <div class="bg-emerald-50 p-2 sm:p-3 rounded-xl text-emerald-600 group-hover:bg-emerald-100 transition-colors self-end sm:self-start">
                            <i data-lucide="check-circle-2" class="w-4 h-4 sm:w-6 sm:h-6"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTROL PANEL (Responsive Layout) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden">
                <!-- Top Bar: Actions -->
                <div class="p-4 sm:p-5 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50">
                    <div class="relative w-full md:max-w-md group">
                        <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                            <i data-lucide="search" class="text-slate-400 w-4 h-4 group-focus-within:text-brand-600 transition-colors"></i>
                        </div>
                        <input type="text" id="search-input" placeholder="Quick search..." 
                            class="pl-10 pr-4 py-2.5 w-full bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-700 shadow-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all outline-none hover:border-slate-300">
                    </div>
                    
                    <button id="btn-open-modal" class="hidden w-full md:w-auto bg-slate-900 hover:bg-brand-600 text-white px-6 py-2.5 rounded-xl font-semibold text-sm shadow-md hover:shadow-lg hover:shadow-brand-500/30 transition-all duration-300 flex items-center justify-center gap-2 group">
                        <i data-lucide="plus-circle" class="w-4 h-4 group-hover:rotate-90 transition-transform"></i>
                        <span>New Entry</span>
                    </button>
                </div>

                <!-- Bottom Bar: Paten Filters (Grid Responsive: 2 Cols on Mobile) -->
                <div class="p-4 sm:p-5 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4">
                    <div class="group">
                        <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Lokasi</label>
                        <div class="relative">
                            <select id="filter-hub" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg py-2.5 px-3 appearance-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none cursor-pointer hover:bg-white transition-all">
                                <option value="">Semua HUB</option>
                            </select>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-3 top-3 pointer-events-none"></i>
                        </div>
                    </div>
                    
                    <div class="group">
                        <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Departemen</label>
                        <div class="relative">
                            <select id="filter-division" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg py-2.5 px-3 appearance-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none cursor-pointer hover:bg-white transition-all">
                                <option value="">Semua Divisi</option>
                            </select>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-3 top-3 pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Dari Tanggal</label>
                        <input type="date" id="filter-start-date" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg py-2.5 px-3 focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none cursor-pointer hover:bg-white transition-all text-slate-600">
                    </div>

                    <div class="group">
                        <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Sampai Tanggal</label>
                        <input type="date" id="filter-end-date" class="w-full text-sm bg-slate-50 border border-slate-200 rounded-lg py-2.5 px-3 focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none cursor-pointer hover:bg-white transition-all text-slate-600">
                    </div>

                    <div class="flex items-end col-span-2 md:col-span-4 lg:col-span-1">
                        <button id="btn-reset-filter" class="w-full py-2.5 bg-white border border-slate-200 text-slate-500 hover:text-brand-600 hover:border-brand-200 hover:bg-brand-50 rounded-lg text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-2 transition-all duration-200">
                            <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- TABLE SECTION (Scrollable on Mobile) -->
            <div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/60 overflow-hidden flex flex-col">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50/80 backdrop-blur border-b border-slate-200 sticky top-0 z-20">
                            <tr>
                                <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-widest w-48 whitespace-nowrap">Identity</th>
                                <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-widest min-w-[320px] whitespace-nowrap">Problem</th>
                                <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-widest min-w-[300px] whitespace-nowrap">Action Plan</th>
                                <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-widest w-40 whitespace-nowrap">Timeline</th>
                                <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-widest w-32 text-center whitespace-nowrap">Status</th>
                                <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-widest w-20 text-center whitespace-nowrap admin-only">Opt</th>
                            </tr>
                        </thead>
                        <tbody id="pica-table-body" class="divide-y divide-slate-100">
                            <tr><td colspan="6" class="px-6 py-20 text-center text-slate-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-2">
                    <span id="showing-text" class="text-xs font-semibold text-slate-500">Ready</span>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-200 px-2 py-1 rounded">Secure Connection</span>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL FORM INPUT -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4 sm:p-6">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[85vh] overflow-y-auto slide-up border border-slate-100 flex flex-col">
            <!-- Modal Header -->
            <div class="px-6 sm:px-8 py-5 sm:py-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur z-20">
                <div>
                    <h3 id="form-title" class="font-bold text-lg sm:text-xl text-slate-800 flex items-center gap-2">
                        Input Data
                    </h3>
                    <p class="text-xs sm:text-sm text-slate-500 mt-1">Isi formulir di bawah untuk mencatat case baru.</p>
                </div>
                <button id="btn-close-modal" class="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-500 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form id="pica-form" class="p-6 sm:p-8 grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6 sm:gap-y-8">
                <input type="hidden" id="entry-id">
                <input type="hidden" id="entry-source" value="public">

                <!-- COL 1 -->
                <div class="space-y-5 sm:space-y-6">
                    <div class="flex items-center gap-2 text-brand-600 font-bold text-xs uppercase tracking-widest mb-2">
                        <i data-lucide="map-pin" class="w-3.5 h-3.5"></i> Identitas & Lokasi
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-600">HUB</label>
                            <select id="hub_in" required class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none bg-slate-50 focus:bg-white transition-all">
                                <option value="">Pilih...</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-600">Divisi</label>
                            <select id="division_in" class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none bg-slate-50 focus:bg-white transition-all mb-2">
                                <option value="" disabled selected>+ Tambah...</option>
                            </select>
                            <div id="division-tags" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold text-slate-600">Tingkat Resiko</label>
                        <div class="grid grid-cols-3 gap-3" id="sensitivity-options"></div>
                        <input type="hidden" id="sensitivity" value="medium">
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold text-slate-600">Judul Masalah</label>
                        <input type="text" id="concern" required placeholder="Judul singkat..." class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none">
                    </div>
                    
                    <div class="space-y-1.5">
                        <div class="flex justify-between">
                            <label class="text-xs font-semibold text-slate-600">Deskripsi Masalah</label>
                            <button type="button" onclick="refineText('problem')" class="text-[10px] font-bold text-brand-600 hover:text-brand-700 bg-brand-50 px-2 py-0.5 rounded flex items-center gap-1 transition-colors"><i data-lucide="wand-2" class="w-3 h-3"></i> Auto-fix</button>
                        </div>
                        <textarea id="problem" required rows="4" placeholder="Detail kronologi..." class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none resize-none"></textarea>
                    </div>
                </div>

                <!-- COL 2 -->
                <div class="space-y-5 sm:space-y-6">
                    <div class="flex items-center gap-2 text-brand-600 font-bold text-xs uppercase tracking-widest mb-2">
                        <i data-lucide="activity" class="w-3.5 h-3.5"></i> Penanganan
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-600">PIC</label>
                            <input type="text" id="pic" required placeholder="Nama PIC" class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-600">Tgl Kejadian</label>
                            <input type="date" id="startDate" required class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none text-slate-600">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <div class="flex justify-between">
                            <label class="text-xs font-semibold text-slate-600">Corrective Action</label>
                            <button type="button" onclick="refineText('corrective')" class="text-[10px] font-bold text-brand-600 hover:text-brand-700 bg-brand-50 px-2 py-0.5 rounded flex items-center gap-1 transition-colors"><i data-lucide="wand-2" class="w-3 h-3"></i> Auto-fix</button>
                        </div>
                        <textarea id="corrective" required rows="2" placeholder="Solusi jangka pendek..." class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none resize-none"></textarea>
                    </div>

                    <div class="space-y-1.5">
                        <div class="flex justify-between">
                            <label class="text-xs font-semibold text-slate-600">Preventive Action</label>
                            <button type="button" onclick="refineText('preventive')" class="text-[10px] font-bold text-brand-600 hover:text-brand-700 bg-brand-50 px-2 py-0.5 rounded flex items-center gap-1 transition-colors"><i data-lucide="wand-2" class="w-3 h-3"></i> Auto-fix</button>
                        </div>
                        <textarea id="preventive" required rows="2" placeholder="Pencegahan jangka panjang..." class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none resize-none"></textarea>
                    </div>

                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Due Date</label>
                                <input type="date" id="dueDate" required class="w-full text-sm border border-slate-300 px-2 py-2 rounded-lg bg-white focus:ring-2 focus:ring-brand-500/20 outline-none text-slate-600">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Actual Finish</label>
                                <input type="date" id="completionDate" class="w-full text-sm border border-slate-300 px-2 py-2 rounded-lg bg-white focus:ring-2 focus:ring-brand-500/20 outline-none text-slate-600">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Status Pekerjaan</label>
                            <div class="grid grid-cols-2 gap-2" id="status-options"></div>
                            <input type="hidden" id="status" value="planned">
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="md:col-span-2 pt-6 border-t border-slate-100 flex justify-end gap-3 sticky bottom-0 bg-white pb-2">
                    <button type="button" id="btn-cancel-modal" class="px-6 py-3 rounded-xl border text-sm font-semibold hover:bg-slate-50">Batal</button>
                    <button type="submit" class="px-8 py-3 rounded-xl bg-brand-600 text-white font-bold text-sm hover:bg-brand-700 shadow-lg transition-all transform active:scale-95 flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Data
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 slide-up border border-slate-100">
            <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-slate-400"></i> Pengaturan Admin
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ganti Kode Unik</label>
                    <input type="password" id="new-code-setting" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-brand-500 outline-none text-center font-bold tracking-widest text-slate-700" placeholder="****">
                </div>
                <div class="flex gap-2 pt-2">
                    <button id="btn-close-settings" class="flex-1 py-2.5 rounded-xl border font-semibold text-sm hover:bg-slate-50">Batal</button>
                    <button id="btn-save-settings" class="flex-1 py-2.5 rounded-xl bg-brand-600 text-white font-bold text-sm hover:bg-brand-700 shadow-md">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // USER CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAqbDeVLDBRDEIfi4RliLMC-3Qrwh8p96k",
            authDomain: "logsheet-5r.firebaseapp.com",
            projectId: "logsheet-5r",
            storageBucket: "logsheet-5r.firebasestorage.app",
            messagingSenderId: "358725557740",
            appId: "1:358725557740:web:664cca8d2ae984221ff4c9"
        };
        const appId = 'pica-system-prod-v1';

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('loading-text').innerText = "Error Inisialisasi Firebase";
            document.getElementById('error-help').classList.remove('hidden');
        }

        // DATA
        const divisionList = ["GA", "HC", "Facility", "Finance", "Transport", "Operation", "IT", "Network", "QA"];
        const hubList = ["Makassar", "Balikpapan", "Banjarmasin", "Manado", "Palangkaraya"];
        
        let currentUserRole = 'none'; // none, guest, admin
        let entries = [];
        let selectedDivisions = [];

        // DOM
        const els = {
            authScreen: document.getElementById('auth-screen'),
            loginForm: document.getElementById('login-form'),
            authLoading: document.getElementById('auth-loading'),
            setupInfo: document.getElementById('setup-info'),
            appContent: document.getElementById('app-content'),
            adminCodeInput: document.getElementById('admin-code-input'),
            loginError: document.getElementById('login-error'),
            userIndicator: document.getElementById('user-indicator'),
            userRoleLabel: document.getElementById('user-role-label'),
            btnNewEntry: document.getElementById('btn-open-modal'),
            btnSettings: document.getElementById('btn-settings'),
            modalOverlay: document.getElementById('modal-overlay'),
            settingsModal: document.getElementById('settings-modal'),
            tableBody: document.getElementById('pica-table-body')
        };

        // INIT
        async function init() {
            try {
                await signInAnonymously(auth);
                const populate = (selId, list) => {
                    const el = document.getElementById(selId);
                    if(el) list.forEach(item => el.add(new Option(item, item)));
                };
                ['filter-hub', 'hub_in'].forEach(id => populate(id, hubList));
                ['filter-division', 'division_in'].forEach(id => populate(id, divisionList));
                await checkAdminConfig();
                setupRealtimeData(); 
            } catch (error) {
                console.error("Init Error:", error);
                document.getElementById('loading-text').innerText = "Gagal Terhubung";
                document.getElementById('error-help').classList.remove('hidden');
            }
        }

        // AUTH FLOW
        async function checkAdminConfig() {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'settings');
                const docSnap = await getDoc(docRef);
                els.authLoading.classList.add('hidden');
                els.loginForm.classList.remove('hidden'); 
                if (!docSnap.exists() || !docSnap.data().adminCode) {
                    try {
                        await setDoc(docRef, { adminCode: '123456' });
                        els.setupInfo.classList.remove('hidden'); 
                    } catch (e) { console.warn("Auto-setup failed:", e); }
                }
            } catch (e) {
                els.authLoading.classList.add('hidden');
                els.loginForm.classList.remove('hidden');
            }
        }

        // Login Actions
        document.getElementById('btn-guest').addEventListener('click', () => setRole('guest'));
        
        document.getElementById('btn-login-admin').addEventListener('click', async () => {
            const input = els.adminCodeInput.value;
            els.loginError.classList.add('hidden');
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'settings');
                const docSnap = await getDoc(docRef);
                let validCode = '123456'; 
                if (docSnap.exists() && docSnap.data().adminCode) validCode = docSnap.data().adminCode;
                if (input === validCode) setRole('admin');
                else throw new Error("Wrong code");
            } catch (e) {
                els.loginError.classList.remove('hidden');
                els.loginError.innerText = "Kode salah atau koneksi bermasalah.";
                els.adminCodeInput.classList.add('border-red-500', 'ring-2', 'ring-red-100');
                setTimeout(() => els.adminCodeInput.classList.remove('border-red-500', 'ring-2', 'ring-red-100'), 2000);
            }
        });

        // Role Management
        function setRole(role) {
            currentUserRole = role;
            els.authScreen.classList.add('hidden');
            els.appContent.classList.remove('hidden'); 
            
            if (role === 'admin') {
                document.getElementById('user-indicator').classList.replace('bg-slate-300', 'bg-emerald-500');
                document.getElementById('user-role-label').innerText = "Admin";
                document.getElementById('user-role-label').classList.replace('text-slate-600', 'text-emerald-600');
                els.btnNewEntry.classList.remove('hidden');
                els.btnSettings.classList.remove('hidden');
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            } else {
                document.getElementById('user-indicator').classList.replace('bg-emerald-500', 'bg-slate-300');
                document.getElementById('user-role-label').innerText = "Guest (View Only)";
                document.getElementById('user-role-label').classList.replace('text-emerald-600', 'text-slate-600');
                els.btnNewEntry.classList.add('hidden');
                els.btnSettings.classList.add('hidden');
            }
            renderTable(); 
        }

        // Settings Actions
        els.btnSettings.addEventListener('click', () => els.settingsModal.classList.remove('hidden'));
        document.getElementById('btn-close-settings').addEventListener('click', () => els.settingsModal.classList.add('hidden'));
        
        document.getElementById('btn-save-settings').addEventListener('click', async () => {
            const newCode = document.getElementById('new-code-setting').value;
            if(newCode) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'settings'), { adminCode: newCode });
                    alert("Kode Admin berhasil diubah!");
                    els.settingsModal.classList.add('hidden');
                } catch(e) { alert("Gagal mengubah kode. Cek izin database."); }
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => location.reload());

        // --- CORE APP LOGIC ---
        function setupRealtimeData() {
            try {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'pica_entries'), (snapshot) => {
                    entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    entries.sort((a,b) => (new Date(b.startDate || 0) - new Date(a.startDate || 0)));
                    renderTable();
                    updateStats();
                });
            } catch(e) { console.error("Setup Data Error", e); }
        }

        function renderTable() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const fHub = document.getElementById('filter-hub').value;
            const fDiv = document.getElementById('filter-division').value;
            const fStart = document.getElementById('filter-start-date').value;
            const fEnd = document.getElementById('filter-end-date').value;

            const filtered = entries.filter(item => {
                const itemDivs = Array.isArray(item.division) ? item.division.join(' ') : (item.division || '');
                const matchSearch = (
                    (item.concern||'').toLowerCase().includes(searchTerm) || 
                    (item.problem||'').toLowerCase().includes(searchTerm) || 
                    (item.pic||'').toLowerCase().includes(searchTerm) || 
                    itemDivs.toLowerCase().includes(searchTerm) ||
                    (item.hub||'').toLowerCase().includes(searchTerm)
                );
                const matchHub = fHub ? item.hub === fHub : true;
                const matchDiv = fDiv ? (Array.isArray(item.division) ? item.division.includes(fDiv) : item.division === fDiv) : true;
                let matchDate = true;
                if (fStart) matchDate = matchDate && (item.startDate >= fStart);
                if (fEnd) matchDate = matchDate && (item.startDate <= fEnd);
                return matchSearch && matchHub && matchDiv && matchDate;
            });

            document.getElementById('showing-text').innerText = `Showing ${filtered.length} records`;

            if(filtered.length === 0) {
                els.tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-20 text-center text-slate-400">No records found</td></tr>`;
            } else {
                els.tableBody.innerHTML = filtered.map(item => {
                    const isFinished = item.status === 'done';
                    const rowClass = isFinished ? 'bg-slate-50/60 hover:bg-slate-100 text-slate-500' : 'bg-white hover:bg-brand-50/40 text-slate-700';
                    const duration = calculateDuration(item.startDate, item.completionDate);
                    const divs = Array.isArray(item.division) ? item.division.join(', ') : (item.division || '-');
                    
                    const actionBtns = currentUserRole === 'admin' ? `
                        <div class="flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <button onclick="editEntry('${item.id}')" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center justify-center transition-colors shadow-sm"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="deleteEntry('${item.id}')" class="w-8 h-8 rounded-lg bg-rose-50 text-rose-600 hover:bg-rose-100 flex items-center justify-center transition-colors shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    ` : '';

                    return `
                    <tr class="group transition-colors border-b border-slate-100 ${rowClass}">
                        <td class="px-6 py-5 align-top">
                            <div class="flex flex-col gap-2">
                                <span class="font-bold text-sm ${isFinished ? 'text-slate-500' : 'text-slate-800'}">${item.hub || '-'}</span>
                                <span class="text-xs font-medium text-slate-500">${divs}</span>
                                <div class="pt-1">${getSensitivityBadge(item.sensitivity)}</div>
                            </div>
                        </td>
                        <td class="px-6 py-5 align-top">
                            <div class="mb-2">
                                <span class="font-bold block text-sm mb-1.5 ${isFinished ? 'text-slate-600' : 'text-slate-900'}">${item.concern || ''}</span>
                                <p class="text-xs leading-relaxed whitespace-pre-wrap font-medium ${isFinished ? 'text-slate-400' : 'text-slate-600'}">${item.problem || ''}</p>
                            </div>
                            <div class="flex items-center gap-2 mt-4 pt-3 border-t border-slate-100/80">
                                <div class="w-5 h-5 rounded-full bg-indigo-100 flex items-center justify-center text-[9px] font-bold text-indigo-700">${item.pic ? item.pic.charAt(0).toUpperCase() : '?'}</div>
                                <span class="text-xs font-semibold text-slate-500">${item.pic || '-'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 align-top">
                            <div class="space-y-4">
                                <div class="relative pl-3 border-l-[3px] border-brand-200">
                                    <span class="text-[9px] font-bold text-brand-600 uppercase block mb-1 tracking-wider">Corrective</span>
                                    <p class="text-xs ${isFinished ? 'text-slate-400' : 'text-slate-700'}">${item.corrective || '-'}</p>
                                </div>
                                <div class="relative pl-3 border-l-[3px] border-emerald-200">
                                    <span class="text-[9px] font-bold text-emerald-600 uppercase block mb-1 tracking-wider">Preventive</span>
                                    <p class="text-xs ${isFinished ? 'text-slate-400' : 'text-slate-700'}">${item.preventive || '-'}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5 align-top">
                            <div class="flex flex-col gap-2 text-[11px]">
                                <div class="flex justify-between items-center bg-slate-50 px-2.5 py-1.5 rounded-lg border border-slate-200">
                                    <span class="text-slate-400 font-semibold uppercase tracking-wider text-[9px]">Start</span>
                                    <span class="font-mono font-bold text-slate-600">${formatDate(item.startDate)}</span>
                                </div>
                                <div class="flex justify-between items-center bg-slate-50 px-2.5 py-1.5 rounded-lg border border-slate-200">
                                    <span class="text-slate-400 font-semibold uppercase tracking-wider text-[9px]">Due</span>
                                    <span class="font-mono font-bold text-slate-600">${formatDate(item.dueDate)}</span>
                                </div>
                                <div class="flex justify-between items-center px-2.5 py-1.5 rounded-lg border ${item.completionDate ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-200'}">
                                    <span class="text-slate-400 font-semibold uppercase tracking-wider text-[9px]">Actual</span>
                                    <span class="font-mono font-bold ${item.completionDate ? 'text-emerald-700' : 'text-slate-300'}">${formatDate(item.completionDate)}</span>
                                </div>
                                ${duration ? `<div class="mt-1 text-center text-[10px] text-slate-400 font-semibold bg-slate-100 rounded py-0.5">Lead Time: <span class="text-slate-800">${duration} Hari</span></div>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-5 align-top text-center pt-6">
                            ${getStatusBadge(item.status)}
                        </td>
                        <td class="px-6 py-5 align-top text-center pt-6 admin-only ${currentUserRole !== 'admin' ? 'hidden' : ''}">
                            ${actionBtns}
                        </td>
                    </tr>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function updateStats() {
            ['total', 'waiting', 'progress', 'closed'].forEach(k => {
                const el = document.getElementById(`kpi-${k}`);
                if(el) el.innerText = k==='total'?entries.length : entries.filter(e => e.status === (k==='closed'?'done':k)).length;
            });
        }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('id-ID', {day:'2-digit', month:'short'}) : '-'; }
        function calculateDuration(s, e) { return (s && e) ? Math.ceil(Math.abs(new Date(e)-new Date(s))/(1000*60*60*24)) : 1; }
        function getStatusBadge(s) {
            const m = { planned: {c:'bg-slate-100 text-slate-600', i:'circle'}, waiting: {c:'bg-purple-50 text-purple-700', i:'pause-circle', anim:'animate-pulse'}, progress: {c:'bg-brand-50 text-brand-700', i:'loader-2', anim:'animate-spin'}, done: {c:'bg-emerald-50 text-emerald-700', i:'check-circle-2'} };
            const c = m[s]||m.planned;
            return `<span class="inline-flex items-center px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider border shadow-sm ${c.c}"><i data-lucide="${c.i}" class="w-3.5 h-3.5 mr-1.5 ${c.anim||''}"></i>${s}</span>`;
        }
        function getSensitivityBadge(l) {
            const m = { low: {c:'text-emerald-700 bg-emerald-50', i:'shield-check'}, medium: {c:'text-amber-700 bg-amber-50', i:'alert-triangle'}, high: {c:'text-rose-700 bg-rose-50', i:'siren'} };
            const c = m[l]||m.medium;
            return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold border ${c.c}"><i data-lucide="${c.i}" class="w-3 h-3 mr-1"></i>${l}</span>`;
        }

        // Modal Logic
        function toggleModal(show) { 
            const m = els.modalOverlay; 
            if(show) { resetForm(); m.classList.remove('hidden'); } else { m.classList.add('hidden'); }
        }
        els.btnNewEntry.addEventListener('click', () => toggleModal(true));
        document.getElementById('btn-close-modal').addEventListener('click', () => toggleModal(false));
        document.getElementById('btn-cancel-modal').addEventListener('click', () => toggleModal(false));
        document.getElementById('modal-overlay').addEventListener('click', (e) => { if(e.target === document.getElementById('modal-overlay')) toggleModal(false); });

        document.getElementById('btn-reset-filter').addEventListener('click', () => {
            ['search-input','filter-hub','filter-division','filter-start-date','filter-end-date'].forEach(id => document.getElementById(id).value = "");
            renderTable();
        });

        ['search-input','filter-hub','filter-division','filter-start-date','filter-end-date'].forEach(id => {
            document.getElementById(id).addEventListener(id==='search-input'?'input':'change', renderTable);
        });

        function renderOptionButtons() {
            const sLevels = ['low', 'medium', 'high'];
            document.getElementById('sensitivity-options').innerHTML = sLevels.map(lvl => {
                const active = document.getElementById('sensitivity').value === lvl;
                let cls = active ? 'bg-slate-800 text-white shadow-lg' : 'bg-white border hover:bg-slate-50';
                return `<button type="button" onclick="setSensitivity('${lvl}')" class="py-2.5 rounded-xl text-xs font-bold uppercase ${cls}">${lvl}</button>`;
            }).join('');
            
            const stats = ['planned','waiting','progress','done'];
            document.getElementById('status-options').innerHTML = stats.map(s => {
                const active = document.getElementById('status').value === s;
                let cls = active ? 'bg-slate-800 text-white shadow-lg' : 'bg-white border hover:bg-slate-50';
                return `<button type="button" onclick="setStatus('${s}')" class="py-2.5 rounded-xl text-xs font-bold uppercase ${cls}">${s}</button>`;
            }).join('');
        }
        window.setSensitivity = (v) => { document.getElementById('sensitivity').value = v; renderOptionButtons(); };
        window.setStatus = (v) => { document.getElementById('status').value = v; renderOptionButtons(); };
        renderOptionButtons();

        window.refineText = (id) => {
            const el = document.getElementById(id);
            let t = el.value.replace(/\s+/g,' ').trim();
            if(t) t = t.charAt(0).toUpperCase() + t.slice(1);
            if(t && !/[.?!]$/.test(t)) t += '.';
            el.value = t;
        };

        // Form Logic
        document.getElementById('division_in').addEventListener('change', (e) => {
            if(e.target.value && !selectedDivisions.includes(e.target.value)) { selectedDivisions.push(e.target.value); renderTags(); }
            e.target.value = "";
        });
        function renderTags() {
            document.getElementById('division-tags').innerHTML = selectedDivisions.map(d => `<span class="bg-brand-50 text-brand-700 px-2 py-0.5 rounded text-xs font-bold border border-brand-100 flex items-center gap-1">${d} <i onclick="removeTag('${d}')" data-lucide="x" class="w-3 h-3 cursor-pointer"></i></span>`).join('');
            lucide.createIcons();
        }
        window.removeTag = (d) => { selectedDivisions = selectedDivisions.filter(x => x !== d); renderTags(); };

        // Submit
        document.getElementById('pica-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(selectedDivisions.length===0) return alert('Pilih Divisi');
            
            const btn = document.querySelector('#pica-form button[type="submit"]');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Saving...`;
            btn.disabled = true;
            lucide.createIcons();

            const id = document.getElementById('entry-id').value;
            const data = {
                hub: document.getElementById('hub_in').value,
                division: selectedDivisions,
                sensitivity: document.getElementById('sensitivity').value,
                concern: document.getElementById('concern').value,
                problem: document.getElementById('problem').value,
                pic: document.getElementById('pic').value,
                startDate: document.getElementById('startDate').value,
                corrective: document.getElementById('corrective').value,
                preventive: document.getElementById('preventive').value,
                dueDate: document.getElementById('dueDate').value,
                completionDate: document.getElementById('completionDate').value,
                status: document.getElementById('status').value,
                updatedAt: serverTimestamp()
            };

            try {
                if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pica_entries', id), data);
                else { data.createdAt = serverTimestamp(); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pica_entries'), data); }
                toggleModal(false);
            } catch(e) { console.error(e); alert('Error saving: Check Permissions'); }
            finally { btn.innerHTML = oldHtml; btn.disabled = false; lucide.createIcons(); }
        });

        // Edit/Delete Globals
        window.editEntry = (id) => {
            const item = entries.find(e => e.id === id);
            document.getElementById('entry-id').value = id;
            document.getElementById('hub_in').value = item.hub;
            selectedDivisions = item.division;
            document.getElementById('sensitivity').value = item.sensitivity;
            document.getElementById('concern').value = item.concern;
            document.getElementById('problem').value = item.problem;
            document.getElementById('pic').value = item.pic;
            document.getElementById('startDate').value = item.startDate;
            document.getElementById('corrective').value = item.corrective;
            document.getElementById('preventive').value = item.preventive;
            document.getElementById('dueDate').value = item.dueDate;
            document.getElementById('completionDate').value = item.completionDate;
            document.getElementById('status').value = item.status;
            renderTags(); renderButtons(); toggleModal(true);
        };

        window.deleteEntry = async (id) => {
            if(confirm('Hapus?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pica_entries', id));
        };

        function resetForm() {
            document.getElementById('pica-form').reset();
            document.getElementById('entry-id').value = "";
            selectedDivisions = [];
            renderTags(); renderButtons();
        }

        init();
        lucide.createIcons();
    </script>
</body>
</html>